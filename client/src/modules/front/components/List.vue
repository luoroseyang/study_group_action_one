<template>
  <div class="list">
    <Side :isInList='true'></Side>
    <div class="list__article">
      <ul>
        <li v-for="(article, index) in posts" class="list__article__item">
          <h1 class="list__article__item__title"><router-link :to="'article/'+article.id">{{ article.title }}</router-link></h1>
          <div class="list__article__item__info">
            <p class="list__article__item__time">{{article.createTime}}</p>
            <div class="list__article__item__abstract markdown-body" v-html="compiledMarkdown(article.abstract)"></div>
            <p>
              <router-link :to="'/article/'+article.id" class="continue-reading">继续阅读...</router-link>
            </p>
          </div>
        </li>
      </ul>
      <Pagination :curPage='curPage' :allPage='allPage' @changePage='changePage'></Pagination>
      <div v-if="posts.length==0 && isLoading==false" class="msg-box">
        <p>暂时没有相关文章</p>
      </div>
    </div>
  </div>
</template>

<script>
import Pagination from 'publicComponents/Pagination.vue'
import Loading from 'publicComponents/Loading.vue'
import Side from './common/Side.vue'
import articleApi from 'api/article.js'
import marked from 'lib/marked.js'

import {
  mapGetters,
  mapActions
} from 'vuex'

export default {
  name: 'list',
  computed: {
    ...mapGetters([
      'posts',
      'tags',
      'curPage',
      'allPage',
      'selectTags',
      'searchTags',
      'currentPost'
    ]),
    filterMsg() {
      let msg = ''
      this.selectTags.forEach((item) => {
        msg += item.name + '、'
      })
      return msg.replace(/、$/, '')
    }
  },
  components: {
    Pagination,
    Side,
    Loading
  },
  data() {
    return {
      isLoading: false
    }
  },
  created() {
  },
  beforeMount() {
    // 用来判断是否有数据，有数据就不再请求了
    if(this.currentPost.id == '') {
      // 这句话说明不是从文章详细页过来的
      return;
    }
    this.isLoading = true;
    this.getAllPosts({page:this.$store.state.route.params.page}).then(()=> {
      this.isLoading = false;
    })
  },
  preFetch(store) {
    store.dispatch('getAllTags')
    return store.dispatch('getAllPosts',{page:store.state.route.params.page}).then(()=>{
    })
  },
  methods: {
    ...mapActions([
      'getAllPosts',
      'getAllTags'
    ]),
    compiledMarkdown(value) {
      return marked(value)
    },
    changePage(cur) {
      this.isLoading = true;
      this.$router.push('/page/' + cur)
      this.getAllPosts({tag:this.searchTags, page:cur}).then(() => {
        this.isLoading = false;
      })
    }
  },
  watch: {
    selectTags() {
      this.isLoading = true;
      this.getAllPosts({
        tag: this.searchTags
      }).then(()=> {
        this.isLoading = false;
      })
    }
  }
}
</script>

<style lang="stylus" scoped>
@import '../assets/stylus/_settings.styl'
.list
  flex 1
  padding 10px
  min-width 1200px
  height 100%
  margin 0 auto
  padding-top 10px
  display: flex;
  &__article
    height 100%
    flex 1
    display flex
    flex-direction column
    justify-content space-between
  &__article__item
    margin 0 auto
    padding 0px 10px 10px 10px
    margin-bottom 15px
    list-style none

  &__article__item__title
    font-size 24px
    word-break break-all
    a
      text-decoration none
      color black
  &__article__item__time
    color #7f8c8d
    font-weight 400
    margin-bottom 10px
    margin-top 2px
  &__article__item__abstract
    margin-bottom 5px
  .continue-reading
    text-decoration none
    color #0366d6
  &__article__filterMsg
    font-size 20px
    text-align center
    span
      color $blue
  &__loading
    position fixed
    top 50%
    left 50%
    width 300px
    height 200px
    margin-left -(@width/2)+125
    margin-top  -(@height/2)+60
  .msg-box
    position fixed
    top 50%
    left 50%
    width 200px
    height 200px
    margin-left -(@width/2)+125
    margin-top  -(@height/2)+60
    text-align center
    color #bfbfbf

@media screen and (max-width: 850px)
  .list
    position relative
    padding-top 80px
    &__article__item
      margin-bottom 10px
    &__article
      margin-left 0
    &__article__filterMsg
      font-size 18px
    .msg-box
      position absolute
      top 250px
      left 50%
      width 300px
      margin-left -(@width/2)
    &__loading
      position absolute
      top 250px
      left 50%
      width 300px
      margin-left -(@width/2)

</style>
